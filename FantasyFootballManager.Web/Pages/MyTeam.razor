@page "/myteam"
@inject Data.FootballPlayerService fps;

<h1>The Corner House</h1>

@if (getPlayersError == true)
{
    <p>Unable to get data from the API This is bad. ðŸ‘Ž</p>
}

@if (shouldRender == false)
{
    <div class="row px-3">
        <div class="col-md-4 p-3"></div>
        <div class="col-md-4 p-3">
            <RadzenCard>
                <h4 class="mb-4">Getting Data from the API</h4>
                <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            </RadzenCard>
        </div>
        <div class="col-md-4 p-3"></div>
    </div>
}
else
{
    // This is where the fun happens!
    <div class="row" style="margin-bottom: 20px;">
        <div class="col-md-3">
            <RadzenCard Style="height:150px;">
                <p class="lead">Total Starters Projected Points</p>
                <h1 class="display-4 text-center">@myStarters.Sum(p => p.ProjectedFantasyPoints)</h1>
            </RadzenCard>
        </div>
        <div class="col-md-3">
            <RadzenCard Style="height:150px;">
                <p class="lead">Total Starters Auction Value</p>
                <h1 class="display-4 text-center">@myStarters.Sum(p => p.AuctionValue)</h1>
            </RadzenCard>
        </div>
        <div class="col-md-3">
            <RadzenCard Style="height:150px;">
                <p class="lead">Total Team Projected Points</p>
                <h1 class="display-4 text-center">@Math.Round(myPlayers.Sum(p => p.ProjectedFantasyPoints), 2)</h1>
            </RadzenCard>
        </div>
        <div class="col-md-3">
            <RadzenCard Style="height:150px;">
                <p class="lead">Total Team Auction Value</p>
                <h1 class="display-4 text-center">@myPlayers.Sum(p => p.AuctionValue)</h1>
            </RadzenCard>
        </div>
    </div>
    <h2>Starters</h2>
    <table class="table table-sm table-striped">
        <tr>
            <th>Position</th>
            <th>Name</th>
            <th>Bye</th>
            <th>Projected Points</th>
            <th>Value</th>
        </tr>
        <tr>
            <td>QB</td>
            @if (teamPlayers.ContainsKey("QB1"))
            {
                <td><a href="/player/@teamPlayers["QB1"].Id">@teamPlayers["QB1"].Name</a></td>
                <td>@teamPlayers["QB1"].Bye</td>
                <td>@teamPlayers["QB1"].ProjectedFantasyPoints</td>
                <td>@teamPlayers["QB1"].AuctionValue</td>
            }
            else { <EmptyRow /> }
        </tr>
        <tr>
            <td>WR</td>
            @if (teamPlayers.ContainsKey("WR1"))
            {
                <td><a href="/player/@teamPlayers["WR1"].Id">@teamPlayers["WR1"].Name</a></td>
                <td>@teamPlayers["WR1"].Bye</td>
                <td>@teamPlayers["WR1"].ProjectedFantasyPoints</td>
                <td>@teamPlayers["WR1"].AuctionValue</td>
            }
            else { <EmptyRow /> }
        </tr>
        <tr>
            <td>WR</td>
            @if (teamPlayers.ContainsKey("WR2"))
            {
                <td><a href="/player/@teamPlayers["WR2"].Id">@teamPlayers["WR2"].Name</a></td>
                <td>@teamPlayers["WR2"].Bye</td>
                <td>@teamPlayers["WR2"].ProjectedFantasyPoints</td>
                <td>@teamPlayers["WR2"].AuctionValue</td>
            }
            else { <EmptyRow /> }
        </tr>
        <tr>
            <td>RB</td>
            @if (teamPlayers.ContainsKey("RB1"))
            {
                <td><a href="/player/@teamPlayers["RB1"].Id">@teamPlayers["RB1"].Name</a></td>
                <td>@teamPlayers["RB1"].Bye</td>
                <td>@teamPlayers["RB1"].ProjectedFantasyPoints</td>
                <td>@teamPlayers["RB1"].AuctionValue</td>
            }
            else { <EmptyRow /> }
        </tr>
        <tr>
            <td>RB</td>
            @if (teamPlayers.ContainsKey("RB2"))
            {
                <td><a href="/player/@teamPlayers["RB2"].Id">@teamPlayers["RB2"].Name</a></td>
                <td>@teamPlayers["RB2"].Bye</td>
                <td>@teamPlayers["RB2"].ProjectedFantasyPoints</td>
                <td>@teamPlayers["RB2"].AuctionValue</td>
            }
            else { <EmptyRow /> }
        </tr>
        <tr>
            <td>TE</td>
            @if (teamPlayers.ContainsKey("TE"))
            {
                <td><a href="/player/@teamPlayers["TE"].Id">@teamPlayers["TE"].Name</a></td>
                <td>@teamPlayers["TE"].Bye</td>
                <td>@teamPlayers["TE"].ProjectedFantasyPoints</td>
                <td>@teamPlayers["TE"].AuctionValue</td>
            }
            else { <EmptyRow /> }
        </tr>
        <tr>
            <td>W/R/T</td>
            @if (teamPlayers.ContainsKey("WRT"))
            {
                <td><a href="/player/@teamPlayers["WRT"].Id">@teamPlayers["WRT"].Name</a></td>
                <td>@teamPlayers["WRT"].Bye</td>
                <td>@teamPlayers["WRT"].ProjectedFantasyPoints</td>
                <td>@teamPlayers["WRT"].AuctionValue</td>
            }
            else { <EmptyRow /> }
        </tr>
        <tr>
            <td>K</td>
            @if (teamPlayers.ContainsKey("K"))
            {
                <td><a href="/player/@teamPlayers["K"].Id">@teamPlayers["K"].Name</a></td>
                <td>@teamPlayers["K"].Bye</td>
                <td>@teamPlayers["K"].ProjectedFantasyPoints</td>
                <td>@teamPlayers["K"].AuctionValue</td>
            }
            else { <EmptyRow /> }
        </tr>
        <tr>
            <td>DEF</td>
            @if (teamPlayers.ContainsKey("DEF"))
            {
                <td><a href="/player/@teamPlayers["DEF"].Id">@teamPlayers["DEF"].Name</a></td>
                <td>@teamPlayers["DEF"].Bye</td>
                <td>@teamPlayers["DEF"].ProjectedFantasyPoints</td>
                <td>@teamPlayers["DEF"].AuctionValue</td>
            }
            else { <EmptyRow /> }
        </tr>
    </table>
    <h2 style="margin-bottom: 10px; margin-top:10px;">Bench</h2>
    <table class="table table-sm table-striped">
        <tr>
            <th>Position</th>
            <th>Name</th>
            <th>Bye</th>
            <th>Projected Points</th>
            <th>Value</th>
        </tr>
        @foreach (var p in myPlayers)
        {
            if (!myStarters.Contains(p))
            {
                <tr>
                    <td>@p.Position</td>
                    <td><a href="/player/@p.Id">@p.Name</a></td>
                    <td>@p.Bye</td>
                    <td>@Math.Round(p.ProjectedFantasyPoints, 2)</td>
                    <td>@p.AuctionValue</td>
                </tr>
            }
        }
    </table>
}

@code {
    private IEnumerable<Data.FootballPlayer> myPlayers = new List<Data.FootballPlayer>();
    private List<Data.FootballPlayer> myStarters = new List<Data.FootballPlayer>();
    private Dictionary<string, Data.FootballPlayer> teamPlayers = new Dictionary<string, Data.FootballPlayer>();
    private bool getPlayersError;
    private bool shouldRender;

    protected override bool ShouldRender() => shouldRender;
    
    protected override async Task OnInitializedAsync()
    {
        // First, lets get all players, and filter it to my team.
        var players = await fps.GetAllFootballPlayersAsync();
        
        if(players.Count() == 0)
        {
            getPlayersError = true;
        }
        else
        {
            myPlayers = players.Where(p => p.IsOnMyTeam == true).OrderByDescending(p => p.ProjectedFantasyPoints).ToList();
            BuildTeam();
        }

        shouldRender = true;
    }

    private void BuildTeam()
    {
        // Here we need to select the players that will be the starters.
       if(myPlayers.Where(p => p.Position == "QB").Any())
        {
            teamPlayers.Add("QB1",  myPlayers.Where(p => p.Position == "QB").ElementAt(0));
            myStarters.Add(myPlayers.Where(p => p.Position == "QB").ElementAt(0));
        }
        if(myPlayers.Where(p => p.Position == "WR").Any())
        {
            teamPlayers.Add("WR1",  myPlayers.Where(p => p.Position == "WR").ElementAt(0));
            myStarters.Add(myPlayers.Where(p => p.Position == "WR").ElementAt(0));
        }
        if(myPlayers.Where(p => p.Position == "WR").Count() > 1)
        {
            teamPlayers.Add("WR2",  myPlayers.Where(p => p.Position == "WR").ElementAt(1));
            myStarters.Add(myPlayers.Where(p => p.Position == "WR").ElementAt(1));
        }
        if(myPlayers.Where(p => p.Position == "RB").Any())
        {
            teamPlayers.Add("RB1",  myPlayers.Where(p => p.Position == "RB").ElementAt(0));
            myStarters.Add(myPlayers.Where(p => p.Position == "RB").ElementAt(0));
        }
        if(myPlayers.Where(p => p.Position == "RB").Count() > 1)
        {
            teamPlayers.Add("RB2",  myPlayers.Where(p => p.Position == "RB").ElementAt(1));
            myStarters.Add(myPlayers.Where(p => p.Position == "RB").ElementAt(1));
        }
        if(myPlayers.Where(p => p.Position == "TE").Any())
        {
            teamPlayers.Add("TE",  myPlayers.Where(p => p.Position == "TE").ElementAt(0));
            myStarters.Add(myPlayers.Where(p => p.Position == "TE").ElementAt(0));
        }
        
        if(myPlayers.Where(p => p.Position == "WR" ||  p.Position == "RB" ||  p.Position == "TE").Any())
        {
            var possibleWRTPlayers = myPlayers.Where(p => p.Position == "WR" ||  p.Position == "RB" ||  p.Position == "TE");
            foreach(var p in possibleWRTPlayers)
            {
                if (!myStarters.Contains(p))
                {
                    teamPlayers.Add("WRT", p);
                    myStarters.Add(p);
                    break;
                }
            }
        }
        
        if(myPlayers.Where(p => p.Position == "K").Any())
        {
            teamPlayers.Add("K",  myPlayers.Where(p => p.Position == "K").ElementAt(0));
            myStarters.Add(myPlayers.Where(p => p.Position == "K").ElementAt(0));
        }
        if(myPlayers.Where(p => p.Position == "DEF").Any())
        {
            teamPlayers.Add("DEF",  myPlayers.Where(p => p.Position == "DEF").ElementAt(0));
            myStarters.Add(myPlayers.Where(p => p.Position == "DEF").ElementAt(0));
        }
    }
}